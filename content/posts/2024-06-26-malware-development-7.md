+++
title = "Red Teamer's Guide to Malware Development 7: Cobalt Strike"
date = 2024-06-19T12:13:12-05:00
draft = true
+++

> This is a guide for malware development. Nowadays, there are many paid courses that cover these same concepts, but fortunately for everyone, these not necessary to get up to speed. Most of the techniques these courses cover are open source.

## Introduction

Cobalt Strike is a popular post-exploitation and command-and-control framework owned by Fortra. Originally developed by Rafael Mudge as an extension to Metasploit, Cobalt Strike is used by red teams and threat actors worldwide for offensive operations. It was first announced by Rafael Mudge [in June of 2012](https://www.cobaltstrike.com/blog/meet-cobalt-strike-adaptive-pen-testing).

From its humble beginnings as an outshoot of the [Armitrage project](https://www.offsec.com/metasploit-unleashed/armitage/), Cobalt Strike has continually evolved to keep pace with advancements in CyberSecurity. Today it boasts one of the largest user bases of any attack tool of its kind globally, and has even been used in advanced persistent threat campaigns like [APT29's Solar Winds supply chain attack](https://cloud.google.com/blog/topics/threat-intelligence/evasive-attacker-leverages-solarwinds-supply-chain-compromises-with-sunburst-backdoor).

Cobalt Strike has become so popular that the use of unlicensed, cracked, and stolen versions in real threat actor campaigns triggered a [Europol Global Action](https://www.europol.europa.eu/media-press/newsroom/news/europol-coordinates-global-action-against-criminal-abuse-of-cobalt-strike) targeting criminal use of Cobalt Strike. The prevalence of its use by real threat actors is a testament to the tools effectiveness in enabling offensive operations.

## Overview of Components

### Beacon

Cobalt Strike is comprised of two essential components: the Beacon, and the Teamserver. The Teamserver is the command and control listener which manages the malware implants (called *Beacon*) on victim machines. The user interacts with the Teamserver through its client interface. From here, the user is able to deploy listeners like HTTP(S) and DNS servers which are able to send and receive data to/from Beacons. The user interfaces with the Teamserver to issue commands to Beacons and receive results.

Some key features of Beacon include the following:

| Action                   | Description                                                     |
|--------------------------|-----------------------------------------------------------------|
| Change Directory         | Change directory                                                |
| Copy File                | Copy a file                                                     | 
| Inject DLL               | Inject a Reflective DLL into a process                          |
| Download File            | Download a file                                                 |
| List Files               | List files                                                      |
| Elevate Privileges       | Spawn a session with elevated privileges                        |
| Execute Program          | Execute a program on target (no output)                         |
| Execute .NET Program     | Run a local .NET program in-memory on target                    |
| Dump Password Hashes     | Dump password hashes                                            |
| Spawn Session            | Start a session in a specific process                           |
| Start Keylogger          | Start a keystroke logger                                        |
| Terminate Process        | Kill a process                                                  |
| Dump Credentials         | Dump credentials and hashes with mimikatz                       |
| Set DNS Mode             | Use DNS as data channel                                         |
| Move File                | Move a file                                                     |
| Network Enumeration      | Network and host enumeration tool                               |
| Scan Network             | Scan a network for open services                                |
| Run PowerShell           | Execute a command via PowerShell                                |
| Inject PowerShell        | Execute PowerShell command in specific process                  |
| Pass-the-Hash            | Pass-the-hash using Mimikatz                                    |
| Print Directory          | Print current directory                                         |
| Query Registry           | Query the registry                                              |
| Remote Execution         | Run a command on a remote host                                  |
| Remove File              | Remove a file or folder                                         |
| Reverse Port Forward     | Set up a reverse port forward                                   |
| Run Program              | Execute a program on target (returns output)                    |
| Run as Admin             | Execute a program in an elevated context                        |
| Set Environment Variable | Set an environment variable                                     |
| Execute Shell Command    | Execute a command via cmd.exe                                   |
| Inject Shellcode         | Inject shellcode into a process                                 |
| Set Sleep Time           | Set beacon sleep time                                           |
| Start SOCKS Server       | Start/Stop a SOCKS server to relay traffic                      |
| Start Session            | Start a session                                                 |
| Steal Token              | Steal access token from a process                               |
| Apply Timestamps         | Apply timestamps from one file to another                       |
| Upload File              | Upload a file                                                   |

### Teamserver

The teamserver is the component which manages all the runtime components of the Cobalt Strike framework. It keeps track of beacons and listeners, and exposes functionality to generate payloads and even the running of web servers for hosting malicious content.

When setting up a Teamserver in order to deploy a beacon to a target, the minimum setup includes specfiying which address for the Teamserver to receive connections on, a password for authentication, and setting up a listener.

![Example of an HTTP listener in Cobalt Strike](/listener-example.png)

The listener is the connection point that Beacons deployed on targets will call back to. When you generate a beacon, the Teamserver will embed that beacon with information on whichever listener you choose, so that Beacon knows where to call back to.

 As of Cobalt Strike 4.10, there are nine types:

| Listener Type    | Process Description                                                                                                                            |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------------|
| DNS              | Commands are transmitted via DNS queries and responses, with the Beacon decoding and executing them, then sending results back through DNS.    |
| HTTP             | Commands are encoded into HTTP requests, retrieved by the Beacon during its polling, executed, and results are sent back via HTTP.             |
| HTTPS            | Similar to HTTP, but commands and results are transmitted over an encrypted HTTPS connection.                                                  |
| SMB              | Commands are sent through SMB named pipes, executed by the Beacon, and results are returned over the same channel.                             |
| TCP              | Commands are transmitted over a raw TCP connection, the Beacon decodes and executes them, then sends results back through TCP.                 |
| External C2      | Commands and results are managed through an external C2 server, integrating custom protocols or services for communication.                    |
| Foreign HTTP     | Allows passing a session to a Metasploit Framework HTTP handler. Allows passing a session from Cobalt Strike to MSF                            |
| Foreign HTTPS    | Similar to Foreign HTTP, but communication is encrypted with HTTPS                                                                             |

